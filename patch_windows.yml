- name: Check Windows Update Service Status
  ansible.windows.win_service:
    name: wuauserv
  register: update_service_status

- name: Start Windows Update Service if not running
  ansible.windows.win_service:
    name: wuauserv
    start_mode: auto
    state: started
  when: update_service_status.state != "running"

- name: Search and Install All Available Windows Updates
  ansible.windows.win_updates:
    reboot: yes
    state: installed
  register: update_result

- name: Reboot if required
  ansible.windows.win_reboot:
    reboot_timeout: 1200
  when: update_result.reboot_required | default(false)

- name: Show installed updates summary
  debug:
    var: update_result

- name: List installed patches (hotfixes)
  ansible.windows.win_shell: |
    Get-HotFix | Select-Object -Property HotFixID, Description, InstalledOn | ConvertTo-Json -Depth 3
  register: installed_patches

- name: Show installed patches
  debug:
    var: installed_patches.stdout | default('[]') | from_json
